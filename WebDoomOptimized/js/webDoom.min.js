class Bitmap{constructor(a,b,c){this.image=new Image,this.image.src=a,this.width=b,this.height=c}}class Player{constructor(a,b,c){this.x=a,this.y=b,this.direction=c,this.weapon=new Bitmap("images/knife_hand.png",319,320),this.paces=0}rotate(a){this.direction=(this.direction+a+2*MATH_PI)%(2*MATH_PI)}walk(a,b){var c=Math.cos(this.direction)*a,d=Math.sin(this.direction)*a;b.wallGrid.tile(this.x+c,this.y)<=0&&(this.x+=c),b.wallGrid.tile(this.x,this.y+d)<=0&&(this.y+=d),this.paces+=a}update(a,b,c){a.left&&this.rotate(-MATH_PI*c),a.right&&this.rotate(MATH_PI*c),a.forward&&this.walk(3*c,b),a.backward&&this.walk(-3*c,b)}}class WallGrid{constructor(a){this.size=a,this.grid=new Uint8Array(a*a)}randomize(){for(var a=0,b=this.size*this.size;a<b;)this.grid[a]=Math.random()<.3?1:0,a++}tile(a,b){let c=Math.floor(a),d=Math.floor(b);return c<0||c>this.size-1||d<0||d>this.size-1?-1:this.grid[d*this.size+c]}}var mapInstance=null;class Map{constructor(a){return null!=mapInstance?mapInstance:(this.wallGrid=new WallGrid(a),this.skybox=new Bitmap("images/deathvalley_panorama.jpg",2e3,750),this.wallTexture=new Bitmap("images/wall_texture.jpg",1024,1024),this.light=0,mapInstance=this)}randomize(){this.wallGrid.randomize()}cast(a,b,c){let e={x:a.x,y:a.y,height:0,distance:0,angle:b,range:c};return this._ray(e)}_ray(a){let b=a,c=Math.sin(b.angle),d=Math.cos(b.angle),e=Map.step(c,d,b.x,b.y),f=Map.step(d,c,b.y,b.x,!0),g=null;return g=e.distance<f.distance?this._inspect(e,1,0,b.distance,e.y,c,d):this._inspect(f,0,1,b.distance,f.x,c,d),g.angle=b.angle,g.range=b.range,g.distance>b.range||1===b.height?[b]:[b].concat(this._ray(g))}static step(a,b,c,d,e){if(0===b)return noWall;var f=0;f=b>0?~~(c+1)-c:Math.ceil(c-1)-c;var g=f*(a/b);if(e)var h=d+g,i=c+f;else var h=c+f,i=d+g;return{x:h,y:i,distance:f*f+g*g}}_inspect(a,b,c,d,e,f,g){let h=g<0?b:0,i=f<0?c:0;a.height=this.wallGrid.tile(a.x-h,a.y-i),a.distance=d+Math.sqrt(a.distance),a.shading=b?g<0?2:0:f<0?2:1;Math.floor(e);return a.offset=e-~~e,a}update(a){var b=Math.random(),c=8*b;this.light>0?this.light=Math.max(this.light-10*a,0):c<a&&(this.light=4)}}class Controls{constructor(){this.codes={37:"left",65:"left",39:"right",68:"right",38:"forward",87:"forward",40:"backward",83:"backward"},this.states={left:!1,right:!1,forward:!1,backward:!1},$(document).on("keydown",a=>{this.onKey(!0,a)}),$(document).on("keyup",a=>{this.onKey(!1,a)}),$(document).on("touchstart",a=>{this.onTouch(a)}),$(document).on("touchmove",a=>{this.onTouch(a)}),$(document).on("touchend",a=>{this.onTouchEnd(a)})}onTouch(a){var b=a.touches[0];this.onTouchEnd(a),b.pageY<.5*window.innerHeight?this.onKey(!0,{keyCode:38}):b.pageX<.5*window.innerWidth?this.onKey(!0,{keyCode:37}):b.pageY>.5*window.innerWidth&&this.onKey(!0,{keyCode:39})}onTouchEnd(a){a.preventDefault(),a.stopPropagation(),this.states={left:!1,right:!1,forward:!1,backward:!1}}onKey(a,b){b.preventDefault(),b.stopPropagation();let c=this.codes[b.keyCode];void 0!==c&&(this.states[c]=a)}}const MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent);class Camera{constructor(a,b,c,d){this.screenWidth=.5*window.innerWidth,this.screenHeight=.5*window.innerHeight,this.preRender=d,a.width=this.screenWidth,a.height=this.screenHeight,this.preRender?(this.screenCtx=a.getContext("2d"),this.offScreenCanvas=this.createOffscreenCanvas(this.screenWidth,this.screenHeight),this.ctx=this.offScreenCanvas.getContext("2d")):this.ctx=a.getContext("2d"),this.width=a.width,this.height=a.height,this.resolution=b,this.spacing=this.width/b,this.focalLength=c||.8,this.lightRange=8,this.scale=(this.width+this.height)/1200,this.range=MOBILE?6:10,this.rainEnabled=!0,this.lighteningEnabled=!0}createOffscreenCanvas(a,b){var c=document.createElement("canvas");return c.width=a,c.height=b,c}render(a,b){this.drawSky(a.direction,b.skybox,b.light),this.drawColumns(a,b),this.drawWeapon(a.weapon,a.paces),this.preRender&&this.screenCtx.drawImage(this.offScreenCanvas,0,0,this.screenWidth,this.screenHeight)}drawSky(a,b,c){var d={width:b.width*(this.height/b.height)*2,left:a/(2*MATH_PI)*-this.width};this.ctx.save(),this.ctx.drawImage(b.image,d.left,0,d.width,this.height),d.left<d.width-this.width&&this.ctx.drawImage(b.image,d.left+d.width,0,d.width,this.height),this.lighteningEnabled&&c>0&&(this.ctx.fillStyle="#ffffff",this.ctx.globalAlpha=.3*c,this.ctx.fillRect(0,0,d.width,.5*this.height)),this.ctx.restore()}drawWeapon(a,b){var c=Math.cos(2*b)*this.scale*6,d=Math.sin(4*b)*this.scale*6,e=.66*this.width+c,f=.6*this.height+d;this.ctx.drawImage(a.image,e,f,a.width*this.scale,a.height*this.scale)}drawColumns(a,b){var c=this.ctx,d=b.wallTexture;c.save();for(var e=0;e<this.resolution;){for(var f=e/this.resolution-.5,g=Math.atan2(f,this.focalLength),h=b.cast(a,a.direction+g,this.range),i=-1,j=1,k=~~(e*this.spacing),l=Math.ceil(this.spacing),m=0,n=h.length;++i<n&&h[i].height<=0;);for(i==n&&(j=.1),i>=this.range/2&&(j=.2);m<n;){var o=h[m];if(m==i){var p=~~(d.width*o.offset),q=this.project(o.height,g,o.distance);c.globalAlpha=1,c.drawImage(d.image,p,0,1,d.height,k,q.top,l,q.height);var r=.4;this.lighteningEnabled&&(r=b.light),c.fillStyle="#000000",c.globalAlpha=Math.max((o.distance+o.shading)/this.lightRange-r,0),c.fillRect(k,q.top,l,q.height)}if(this.rainEnabled){c.fillStyle="#ffffff",c.globalAlpha=.15;for(var s=Math.pow(Math.random(),3)*((n-m)*j),t=s>0&&this.project(.1,g,o.distance);--s>0;)c.fillRect(k,Math.random()*t.top,1,t.height)}m++}e++}c.restore()}project(a,b,c){var d=c*Math.cos(b),e=this.height*a/d;return{top:this.height/2*(1+1/d)-e,height:e}}}const SECONDS_AS_MS=1e3,TARGET_FPS=70,TARGET_MS_PER_TICK=SECONDS_AS_MS/TARGET_FPS,MATH_PI=3.141592653589793;var gameInstance=null;class Game{constructor(){if(null!=gameInstance)return gameInstance;gameInstance=this;let a={tick:0,lastTime:0,theMap:null,theCharacter:null,theControls:null,theCamera:null};__private__.set(this,a);let b=a;setInterval(()=>{let a=__private__.get(this);a.tick++;a.tick>240&&(a.tick=0)},TARGET_MS_PER_TICK);let d=MOBILE?256:512;return b.theMap=new Map(100),b.theCharacter=new Player(15.3,-1.2,.3*MATH_PI),b.theControls=new Controls,b.theCamera=new Camera($("#display").get(0),d,.9,!0),$("#start-button").on("click",a=>{$("#start-button").fadeOut(1*SECONDS_AS_MS);$("#splash-screen").fadeOut(3*SECONDS_AS_MS);$("#game-area").fadeIn(1*SECONDS_AS_MS);$("#hud-overlay").fadeIn(2*SECONDS_AS_MS)}),$("#the-button").on("click",()=>{$.post("server.php","cmd=update").then(a=>{})}),gameInstance}run(){let a=__private__.get(this);$("#splash-screen").hide(),$("#splash-screen").show(),a.theMap.randomize(),this._start(this._renderFrame)}_start(a){__private__.get(this);window.requestAnimationFrame(a=>{this._frame(a)})}_frame(a){let b=__private__.get(this),c=(a-b.lastTime)/SECONDS_AS_MS;b.lastTime=a,this._update(c),this._render(c),window.requestAnimationFrame(a=>{this._frame(a)})}_update(a){let b=__private__.get(this);b.tick++,b.tick>240&&(b.tick=0),b.theMap.update(a),b.theCharacter.update(b.theControls.states,b.theMap,a)}_render(a){let b=__private__.get(this);b.theCamera.render(b.theCharacter,b.theMap)}}$(document).ready(()=>{let a=new Game;a.run()});